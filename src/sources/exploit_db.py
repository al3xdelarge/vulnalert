import requests

from source_classes.base import TITLE_MAX_LENGTH
from source_classes.rss import RSS
from utils.helper import truncate_string
from utils.statics import TYPE_EXPLOIT, LANGUAGE_ENGLISH


class ExploitDatabase(RSS):
    name = 'exploit.db'
    url = 'https://www.exploit-db.com/rss.xml'
    main_type = TYPE_EXPLOIT
    language = LANGUAGE_ENGLISH
    EXCLUDE_TERMS = ['https://phpgurukul.com', 'sourcecodester.com']

    def process_articles(self):
        processed_articles = list()
        for article in self.articles:
            # exclude local exploits
            if '[local]' in article.full_title:
                continue

            # strip prefix
            if article.full_title.startswith("["):
                article.full_title = article.full_title.split("]", maxsplit=1)[-1].strip()
                article.title = truncate_string(article.full_title, maxlen=TITLE_MAX_LENGTH)

            # exclude software from sourcecodester.com
            try:
                r = requests.get(
                    article.url.replace('/exploits/', '/download/'),
                    headers={'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0'},
                    timeout=5)
            except requests.RequestException:
                r = None
            if r:
                if any([t in r.text for t in self.EXCLUDE_TERMS]):
                    continue

            processed_articles.append(article)
        self.articles = processed_articles
